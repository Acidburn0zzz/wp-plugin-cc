<?php
/*
Plugin Name: Creative Commons
Description: Official Creative Commons plugin for WordPress. Allows
users to select and display Creative Commons licenses for their
content. Partially inspired by the License plugin by mitcho (Michael
Yoshitaka Erlewine) and Brett Mellor, as well as the original
WpLicense plugin by CC CTO Nathan R. Yergler.
Version: 2.0
Author: Bjorn Wijers <burobjorn@burobjorn.nl>, Tarmo Toikkanen <tarmo@iki.fi>, Matt Lee <mattl@creativecommons.org>
Plugin URI: http://wiki.creativecommons.org/WpLicense
License: GPLv2 or later versions
*/

add_filter("attachment_fields_to_edit", "add_image_source_url", 10, 2);
function add_image_source_url($form_fields, $post) {
  $form_fields["source_url"] = array(
				     "label" => __("Source URL"),
				     "input" => "text",
				     "value" => get_post_meta($post->ID, "source_url", true),
				     "helps" => __("Add the URL where the original image was posted"),
				     );
  $form_fields["license_url"] = array(
				     "label" => __("License URL"),
				     "input" => "text",
				     "value" => get_post_meta($post->ID, "license_url", true),
				     "helps" => __("Add the URL for the license for the work"),
				     );

				     return $form_fields;
}

add_filter("attachment_fields_to_save", "save_image_source_url", 10 , 2);
function save_image_source_url($post, $attachment) {
  if (isset($attachment['source_url']))
    update_post_meta($post['ID'], 'source_url', esc_url($attachment['source_url']));
  if (isset($attachment['license_url']))
    update_post_meta($post['ID'], 'license_url', esc_url($attachment['license_url']));
  return $post;
}

!defined('ABSPATH') && exit;

function be_caption_no_padding( $output, $attr, $content ) {
  extract(shortcode_atts(array(
		'id'	=> '',
		'align'	=> 'alignnone',
		'width'	=> '',
		'caption' => ''
			       ), $attr, 'caption'));

  // Extract attachment $post->ID
  preg_match('/\d+/', $attr['id'], $att_id);

  error_log($attr['id']);
	
  if (is_numeric($att_id[0]) && $license_url = get_post_meta($att_id[0], 'license_url', true)) {

   $source_url = get_post_meta($att_id[0], 'source_url', true);

    error_log("hello world 2222");
	  
    $parts = parse_url($source_url);
    $caption .= ' ('. __('via') .' <a href="'. $source_url .'">'. $parts['host'] .'</a>)';
  }

  if (1 > (int) $width || empty($caption))
    return $content;

  if ($id)
    $id = 'id="' . esc_attr($id) . '" ';

  return '<div ' . $id . 'class="wp-caption ' . esc_attr($align) . '" style="width: ' . (10 + (int) $width) . 'px">'
    . do_shortcode($content) . '<p class="wp-caption-text">' . $caption . '</p></div>';
}
add_filter( 'img_caption_shortcode', 'be_caption_no_padding', 10, 3 );

add_filter('img_caption_shortcode', 'cc_caption_image', 10, 3);
function cc_caption_image($empty, $attr, $content) {
  extract(shortcode_atts(array(
			       'id'=> '',
			       'align'=> 'alignnone',
			       'width'=> '',
			       'caption' => ''
			       ), $attr));


  error_log('nothing touches me');

  // Extract attachment $post->ID
  preg_match('/\d+/', $attr['id'], $att_id);

  error_log($attr['id']);
	
  if (is_numeric($att_id[0]) && $source_url = get_post_meta($att_id[0], 'source_url', true)) {

    error_log("hello world 2222");

    $license_url = strtolower(get_post_meta($att_id[0], 'license_url', true));

    $parts = parse_url($source_url);  
    $caption .= ' ('. __('via') .' <a href="'. $source_url .'">'. $parts['host'] .'</a>)';


    if (strpos($license_url, "creativecommons")) {

      if (substr($license_url,-1) != "/") {
	$license_url = $license_url . "/";
      }

      if (strpos($license_url, "/by/")) { $license_code = "CC BY"; }
      if (strpos($license_url, "/by-sa/")) { $license_code = "CC BY SA"; }
      if (strpos($license_url, "/by-sa-nc/")) { $license_code = "CC SA NC"; }
      if (strpos($license_url, "/by-nd/")) { $license_code = "CC ND"; }
      if (strpos($license_url, "/by-nc/")) { $license_code = "CC NC"; }
      if (strpos($license_url, "/by-nc-nd/")) { $license_code = "CC NC ND"; }
      if (strpos($license_url, "/publicdomain/")) { $license_code = "public domain"; }
      
      $caption .= ' License: <a href="' . $license_url . '">' . $license_code . '</a>';

      }
	
  }

  if (1 > (int) $width || empty($caption))
    return $content;

  if ($id)
    $id = 'id="' . esc_attr($id) . '" ';

  return '<div ' . $id . 'class="wp-caption ' . esc_attr($align) . '" style="width: ' . (10 + (int) $width) . 'px">'
    . do_shortcode($content) . '<p class="wp-caption-text">' . $caption . '</p></div>';
}
    



?>
